{"version":3,"sources":["tiltontec/cell/evaluate.cljc"],"mappings":"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","names":["cljs.core/*print-level*","tiltontec.cell.evaluate/ephemeral-reset","rc","tiltontec.cell.base/c-ephemeral?","tiltontec.cell.integrity/call-with-integrity","opcode","defer-info","temp__5753__auto__","me","cljs.core/deref","cljs.core.swap_BANG_","cljs.core/assoc","tiltontec.cell.evaluate/record-dependency","used","tiltontec.cell.base/c-optimized-away?","js/Error","tiltontec.cell.base/*depender*","tiltontec.util.base.call_trc","tiltontec.cell.base/c-slot","tiltontec.util.core/rmap-setf","cljs.core.conj","tiltontec.cell.base/c-useds","tiltontec.cell.base/caller-ensure","tiltontec.cell.evaluate/ensure-value-is-current","c","debug-id","ensurer","tiltontec.cell.base/*not-to-be*","tiltontec.cell.base/c-unbound?","tiltontec.util.core/err","tiltontec.cell.base/c-model","tiltontec.cell.base/c-valid?","tiltontec.cell.base/c-value","tiltontec.cell.integrity/c-current?","and__4251__auto__","tiltontec.cell.base/c-input?","tiltontec.cell.base/c-formula?","cljs.core._EQ_","tiltontec.cell.base/c-optimize","md","tiltontec.cell.base/mdead?","cljs.core/str","or__4253__auto__","G__29245","vec__29246","seq__29247","cljs.core/seq","first__29248","cljs.core/first","cljs.core/next","vec__29249","seq__29250","first__29251","urest","tiltontec.cell.base/c-pulse-last-changed","tiltontec.cell.base/c-pulse","tiltontec.cell.evaluate/calculate-and-set","tiltontec.cell.integrity/c-pulse-update","tiltontec.cell.evaluate/c-get","tiltontec.cell.base/c-ref?","result__26632__auto__","prior-value","tiltontec.cell.base/c-md-name","ev","tiltontec.cell.base/c-state","tiltontec.cell.base/+pulse+","tiltontec.cell.base/c-pulse-observed","tiltontec.cell.observer.c_observe","tiltontec.util.core/any-ref?","tiltontec.cell.evaluate/<cget","dbgid","dbgdata","vec__29252","cljs.core.nth","raw-value","propagation-code","tiltontec.cell.evaluate/calculate-and-link","cljs.core/map?","tiltontec.cell.evaluate/c-value-assume","*call-stack*-orig-val__29255","*depender*-orig-val__29256","*defer-changes*-orig-val__29257","*call-stack*-temp-val__29258","*depender*-temp-val__29259","*defer-changes*-temp-val__29260","tiltontec.cell.base/*call-stack*","cljs.core/cons","tiltontec.cell.base/*defer-changes*","tiltontec.cell.evaluate/unlink-from-used","tiltontec.cell.base/c-rule","cljs.core/type","fexpr__29261","prop-code?","tiltontec.cell.base/c-synaptic?","cljs.core/vector?","cljs.core/contains?","cljs.core/meta","js/tiltontec","js/tiltontec.cell","js/tiltontec.cell.evaluate","js/tiltontec.cell.evaluate.c-awaken","method-table__4747__auto__","cljs.core.atom","prefer-table__4748__auto__","method-cache__4749__auto__","cached-hierarchy__4750__auto__","hierarchy__4751__auto__","cljs.core.get","fexpr__29262","cljs.core/MultiFn","cljs.core.symbol","tiltontec.cell.evaluate/c-awaken","cljs.core/seq?","cljs.core/coll?","cljs.core.doall","iter__4652__auto__","s__29267","cljs.core/LazySeq","cljs.core/chunked-seq?","c__4650__auto__","size__4651__auto__","cljs.core/count","b__29269","cljs.core/chunk-buffer","i__29268","cljs.core/-nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__29266","cljs.core/chunk-rest","cljs.core/rest","ce","cljs.core.println","tiltontec.cell.base/c-me","*depender*-orig-val__29278","*depender*-temp-val__29279","tiltontec.cell.evaluate/md-slot-value-store","slot","value","new-value","*depender*-orig-val__29281","*depender*-temp-val__29282","prior-state","tiltontec.cell.base/c-value-state","cljs.core/not","cljs.core/some","tiltontec.cell.evaluate/c-value-changed?","callers","tiltontec.cell.base/c-callers","optimize","G__29284","tiltontec.cell.evaluate/optimize-away?!","tiltontec.cell.evaluate/propagate","why","s__29287","b__29289","i__29288","iter__29286","cljs.core.disj","tiltontec.cell.evaluate/md-cell-flush","cljs.core/empty?","tiltontec.util.core/rmap-meta-setf","cljs.core.assoc","seq__29294","chunk__29295","count__29296","i__29297","c__4679__auto__","cljs.core/chunk-first","caller","cljs.core.remove","tiltontec.cell.base/caller-drop","cljs.core/reset!","tiltontec.cell.evaluate/c-quiesce","tiltontec.cell.base/unlink-from-callers","tiltontec.cell.evaluate/not-to-be-self","seq__29300","chunk__29301","count__29302","i__29303","cljs.core/vals","js/tiltontec.cell.evaluate.not-to-be","fexpr__29307","tiltontec.cell.evaluate/not-to-be","tiltontec.cell.base/md-ref?","tiltontec.cell.base/ia-type","js/tiltontec.cell.evaluate.unchanged-test","fexpr__29309","tiltontec.cell.evaluate/unchanged-test","self","slotname","cljs.core/=","old-value","fexpr__29311","tiltontec.cell.evaluate/*custom-propagater*","tiltontec.cell.integrity/*one-pulse?*","*depender*-orig-val__29316","*call-stack*-orig-val__29317","*c-prop-depth*-orig-val__29318","*defer-changes*-orig-val__29319","*depender*-temp-val__29320","*call-stack*-temp-val__29321","*c-prop-depth*-temp-val__29322","*defer-changes*-temp-val__29323","tiltontec.cell.base/*c-prop-depth*","tiltontec.cell.base/md-slot-owning?","ownees","clojure.set.difference","tiltontec.util.core/set-ify","seq__29324","chunk__29325","count__29326","i__29327","ownee","tiltontec.cell.evaluate/propagate-to-callers","tiltontec.cell.base/c-lazy","causation","tiltontec.cell.base/*causation*","*causation*-orig-val__29330","*causation*-temp-val__29331","seq__29332","chunk__29333","count__29334","i__29335"],"sourcesContent":["(ns tiltontec.cell.evaluate\n  (:require\n      [clojure.set :refer [difference]]\n      ;#?(:clj [taoensso.tufte :as tufte :refer :all]\n      ;   :cljs [taoensso.tufte :as tufte :refer-macros (defnp p profiled profile)])\n      #?(:cljs [tiltontec.util.base\n                      :refer-macros [wtrx trx prog1]]\n               :clj  [tiltontec.util.base\n                      :refer :all])\n      [tiltontec.util.core\n       :refer [any-ref? rmap-setf err rmap-meta-setf set-ify]]\n      #?(:clj [tiltontec.cell.base :refer :all :as cty]\n         :cljs [tiltontec.cell.base\n                :refer-macros [without-c-dependency pcell]\n                :refer [c-optimized-away? c-formula? c-value c-optimize\n                        c-unbound? c-input?  ia-type\n                        c-model mdead? c-valid? c-useds c-ref? md-ref?\n                        c-state +pulse+ c-pulse-observed\n                        *call-stack* *defer-changes*\n                        c-rule c-me c-value-state c-callers caller-ensure\n                        unlink-from-callers *causation*\n                         c-synaptic? caller-drop c-md-name\n                        c-pulse c-pulse-last-changed c-ephemeral? c-slot\n                        *depender* *not-to-be* \n                        *c-prop-depth* md-slot-owning? c-lazy] :as cty])\n      [tiltontec.cell.observer :refer [ c-observe]]\n      #?(:cljs [tiltontec.cell.integrity\n                :refer-macros [with-integrity]\n                :refer [*one-pulse?* c-current?  c-pulse-update]]\n         :clj [tiltontec.cell.integrity :refer :all])))\n\n\n\n#?(:cljs (set! *print-level* 3))\n\n(defn ephemeral-reset [rc]\n  ;; (trx :eph-reset?????? (:slot @rc)(:ephemeral? @rc)) \n  (when (c-ephemeral? rc)                                   ;; allow call on any cell, catch here\n    ;\n    ; as of Cells3 we defer resetting ephemerals because everything\n    ; else gets deferred and we cannot /really/ reset it until\n    ; within finish_business we are sure all callers have been recalculated\n    ; and all observers completed (which happens with recalc).\n    ;\n    ;;(trx :ephh-reset!!! (:slot @rc))\n    (with-integrity (:ephemeral-reset rc)\n      (when-let [me (:me @rc)]\n        ;; presumption next is that model cells live in\n        ;; their own internal slot of model FNYI\n        (#?(:clj alter :cljs swap!) me assoc (:slot @rc) nil))\n      (#?(:clj alter :cljs swap!) rc assoc :value nil))))\n\n(defn record-dependency [used]\n  (when-not (c-optimized-away? used)\n    (assert *depender*)\n    (trx nil :reco-dep!!! :used (c-slot used) :caller (c-slot *depender*))\n    (rmap-setf [:useds *depender*]\n               (conj (c-useds *depender*) used))\n    (caller-ensure used *depender*)))\n\n(declare calculate-and-set)\n\n(defn ensure-value-is-current\n  \"The key to data integrity: recursively check the known dependency\n  graph to decide if we are current, and if not kick off recalculation\n  and propagation.\"\n  \n  [c debug-id ensurer]\n\n  (cond\n                                        ; --------------------------------------------------\n    *not-to-be*                                             ; we got kicked off during not-to-be processing\n                                        ; just return what we have if valid, else nil\n    (cond\n      (c-unbound? c)\n      (do\n        (trx :unbound!!! c-slot)\n        (err \"evic> unbound slot %s of model %s\"\n             (c-slot c) (c-model c)))\n      \n      (c-valid? c)                                          ;; probably accomplishes nothing\n      (c-value c))\n\n    ;; --- easy way out: our pulse is current ---------------\n    (c-current? c)\n    (c-value c)\n\n    ;; --- also easy with an optimize edge case lost to history -------\n    (and (c-input? c)\n      (c-valid? c)                                          ;; a cFn (ruled-then-input) cell will not be valid at first\n      (not (and (c-formula? c)\n             (= (c-optimize c) :when-value-t)\n             (nil? (c-value c)))))\n    (c-value c)\n\n    ;; --- above we had valid values so did not care. now... -------\n    (when-let [md (c-model c)]\n      (mdead? (c-model c)))\n    (err #?(:clj format :cljs str) \"evic> model %s of cell %s is dead\" (c-model c) c)\n\n    ;; --- no more early exits  -------------------\n    (or (not (c-valid? c))\n      (loop [[used & urest] (seq (c-useds c))]\n        (when used\n          ;;(pcell :cnset-evicing used)\n          ;;(pcell :cnset-user c)\n          (ensure-value-is-current used :nested c)\n          ;; now see if it actually changed\n          ;; (println :pulse-checks (c-slot used)(c-pulse-last-changed used)(c-slot c)(c-pulse c))\n          (or (> (c-pulse-last-changed used)(c-pulse c))\n            (recur urest)))))\n    (do                                                     ;; we seem to need update, but...\n      (when-not (c-current? c)\n        ;;(println :not-current-so-calc!!!!!!! (c-slot c)(c-state c)(c-valid? c))\n        ;; happens if dependent changed and its observer read/updated me\n        (calculate-and-set c :evic ensurer))\n      (c-value c))\n\n    ;; we were behind the pulse but not affected by the changes that moved the pulse\n    ;; record that we are current to avoid future checking:\n    :else (do\n            ;;(trx :just-pulse!!!!! (c-slot c))\n            (c-pulse-update c :valid-uninfluenced)\n            (c-value c))))\n                         \n(defn c-get\n  \"The API for determing the value associated with a Cell.\n  Ensures value is current, records any dependent, and\n  notices if a standalone  cell has never been observed.\"\n\n  [c]\n  #_(when (= (c-slot c) :title)\n      (println :cget-entry (c-slot c) (ia-type (c-model c))\n               (if *depender* (c-slot *depender*) :nodepender)))\n  (cond\n    (c-ref? c) (prog1\n                (with-integrity ()\n                  (let [prior-value (c-value c)]\n                    #_(println :cget-to-evic (c-slot c) (ia-type (c-model c)))\n                      (when *depender*\n                        (str \"asker=\"\n                          (c-slot *depender*)\n                          (c-md-name *depender*)))\n                    (prog1\n\n                     (let [ev (ensure-value-is-current c :c-read nil)]\n                        ;; (when (= (c-slot c) :title) (println :evic ev))\n                        ev)\n                     ;; this is new here, intended to awaken standalone cells JIT\n                     ;; /do/ might be better inside evic, or test here\n                     ;; to see if c-model is nil? (trying latter...)\n                     (when (and (nil? (c-model c))\n                                (= (c-state c) :nascent)\n                                (> @+pulse+ (c-pulse-observed c)))\n                       (rmap-setf [::cty/state c] :awake)\n                       (c-observe c prior-value :cget)\n                       (ephemeral-reset c)))))\n                (when *depender*\n                  (record-dependency c)))\n    (any-ref? c) @c\n    :else c))\n\n(defn <cget [c]\n  (c-get c))\n\n(declare calculate-and-link\n         c-value-assume)\n\n(defn calculate-and-set\n  \"Calculate, link, record, and propagate.\"\n  [c dbgid dbgdata]\n  (do                                                       ;; (wtrx [0 20 :cnset-entry (c-slot c)]\n    (let [[raw-value propagation-code] (calculate-and-link c)]\n      ;;(trx :cn-set-sees!!!! (c-slot c) raw-value propagation-code)\n      (when-not (c-optimized-away? c)\n        (assert (map? @c) \"calc-n-set\")\n\n        ;; this check for optimized-away? arose because a rule using without-c-dependency\n        ;; can be re-entered unnoticed since that clears *call-stack*. If re-entered, a subsequent\n        ;; re-exit will be of an optimized away cell, which will have been assumed\n        ;; as part of the opti-away processing.\n        ;;(trx :calc-n-set->assume raw-value)\n        (c-value-assume c raw-value propagation-code)))))\n\n(declare unlink-from-used)\n\n(defn calculate-and-link\n  \"The name is accurate: we do no more than invoke the\n  rule of a formula and return its value*, but along the\n  way the links between dependencies and dependents get\n  determined anew.\n\n  * Well, we also look to see if a synaptic cell has attached a\n  propagaion code to a vector used to wrap the raw value, which we then unpack.\"\n  [c]\n  (binding [*call-stack* (cons c *call-stack*)\n            *depender* c\n            *defer-changes* true]\n    (unlink-from-used c :pre-rule-clear)\n    (assert (c-rule c) (#?(:clj format :cljs str) \"No rule in %s type %s\" (:slot c)(type @c)))\n\n    (let [raw-value ((c-rule c) c)\n          prop-code? (and (c-synaptic? c)\n                         (vector? raw-value)\n                         (contains? (meta raw-value) :propagate))]\n\n      (if prop-code?\n        [(first raw-value) (:propagate  (meta raw-value) )]\n        [raw-value nil]))))\n\n;;; --- awakening ------------------------------------\n\n(defmulti c-awaken (fn [c]\n                     #?(:clj (type c)\n                        :cljs (:type (meta c)))))\n\n(defmethod c-awaken :default [c]\n  (trx :awk-fallthru-entry (type c)(seq? c)(coll? c)(vector? c))\n  (cond\n    (coll? c) (doall (for [ce c]\n                       (c-awaken ce)))\n    :else\n    (println :c-awaken-fall-thru (if (any-ref? c)\n                                   [:ref-of (type c) @c]\n                                   [:unref c (type c)]))))\n\n(defmethod c-awaken ::cty/cell [c]\n  (assert (c-input? c))\n  ;\n  ; nothing to calculate, but every cellular slot should be output on birth\n  ;\n\n  (#?(:clj dosync :cljs do)\n  ;;(prn :awk-c c @+pulse+ (c-pulse-observed c)(c-value-state c))\n   (when (> @+pulse+ (c-pulse-observed c))                  ;; safeguard against double-call\n     (when-let [me (c-me c)]\n       (rmap-setf [(c-slot c) me] (c-value c)))\n     (c-observe c :cell-awaken)\n     (ephemeral-reset c))))\n\n(defmethod c-awaken ::cty/c-formula [c]\n  (#?(:clj dosync :cljs do)\n   ;; hhack -- bundle this up into reusable with evic\n   ;;(trx :c-formula-awk (c-slot c)(c-current? c))\n   (binding [*depender* nil]\n     (when-not (c-current? c)\n       (calculate-and-set c :fn-c-awaken nil)))))\n\n;; ------------------------------------------------------------\n\n(declare c-absorb-value\n         optimize-away?!\n         propagate\n         c-value-changed?)\n\n(defn md-slot-value-store [me slot value]\n  (assert me)\n  (assert (any-ref? me))\n  ;(trx :mdsv-store slot (flz value))\n  (rmap-setf [slot me] value))\n\n(defn c-value-assume\n  \"The Cell assumes a new value at awakening, on c-reset!, or\n   after formula recalculation.\n\n  We record the new value, set the Cell state to :awake, make\n  its pulse current, check to see if a formula cell can be\n  optimized away, and then propagate to any dependent formula\n  cells.\"\n\n  [c new-value propagation-code]\n\n  (assert (c-ref? c))\n  ;; (println :cva-entry (c-slot c) new-value)\n  (do                                                       ;; (wtrx (0 100 :cv-ass (:slot @c) new-value)\n        (prog1 new-value                                    ;; sans doubt\n               (without-c-dependency\n                (let [prior-value (c-value c)\n                      prior-state (c-value-state c)]\n\n                  ;; --- cell maintenance ---\n                  ;; hhhack: new for 4/19/2016: even if no news at\n                  ;; least honor the reset!\n                  ;;\n                  (rmap-setf [:value c] new-value)\n                  (rmap-setf [::cty/state c] :awake)\n                  #_ (trx :new-vlue-installed (c-slot c) \n                       new-value\n                       (:value c))\n                  ;; \n                  ;; --- model maintenance ---\n                  (when (and (c-model c)\n                             (not (c-synaptic? c)))\n                    (md-slot-value-store (c-model c) (c-slot c) new-value))\n                  ;;(trx :val-stored new-value)\n                  (c-pulse-update c :slotv-assume)\n                  #_(println :maybe-propping  (c-slot c) new-value\n                           :priorstate prior-state\n                           :propcode propagation-code\n                           :changed? (c-value-changed? c new-value prior-value))\n                  (when (or (not (some #{prior-state} [:valid :uncurrent]))\n                            (= propagation-code true)       ;; forcing\n                            (when-not (= propagation-code false)\n                              (c-value-changed? c new-value prior-value)))\n                    ;;\n                    ;; --- something happened ---\n                    ;;\n                    ;; we may be overridden by a :no-propagate below, but anyway\n                    ;; we now can look to see if we can be optimized away\n                    ;;(trx :sth-happened)\n                    (let [callers (c-callers c)]            ;; get a copy before we might optimize away\n                      (when-let [optimize (and (c-formula? c)\n                                               (c-optimize c))]\n\n                        (case optimize\n                          :when-value-t (when (c-value c)\n                                          (trx nil :when-value-t (c-slot c))\n                                          (unlink-from-used c :when-value-t))\n                          true (optimize-away?! c prior-value)))\n\n                      ;; --- data flow propagation -----------\n\n                      (when-not (or (= propagation-code :no-propagate)\n                                    (c-optimized-away? c))\n                        (assert (map? @c))\n                        #_(println :propping!!!! (c-slot c) new-value prior-value\n                                 :to-caller-ct (count callers))\n                        (propagate c prior-value callers)))))))))\n\n\n;; --- unlinking ----------------------------------------------\n(defn unlink-from-used [c why]\n  \"Tell dependencies they need not notify us when they change,\nthen clear our record of them.\"\n  (for [used (c-useds c)]\n    (do\n        (rmap-setf [:callers used] (disj (c-callers used) c))))\n\n  (rmap-setf [:useds c] #{}))\n\n(defn md-cell-flush [c]\n  (assert (c-ref? c))\n  (when-let [me (c-model c)]\n    (rmap-setf [:cells-flushed me]\n               (conj (:cells-flushed me)\n                     [(c-slot c)(c-pulse-observed c)]))))\n\n;; --- optimize away ------------------------------------------\n;; optimizing away cells who turn out not to depend on anyone \n;; saves a lot of work at runtime.\n\n\n(defn optimize-away?!\n  \"Optimizes away cells who turn out not to depend on anyone, \n  saving a lot of work at runtime. A caller/user will not bother\n  establishing a link, and when we get to models cget will \n  find a non-cell in a slot and Just Use It.\"\n\n  [c prior-value]\n  (when (and (c-formula? c)\n             (empty? (c-useds c))\n             (c-optimize c)\n             (not (c-optimized-away? c))                    ;; c-streams (FNYI) may come this way repeatedly even if optimized away\n             (c-valid? c)                                   ;; /// when would this not be the case? and who cares?\n             (not (c-synaptic? c))                          ;; no slot to cache invariant result, so they have to stay around)\n             (not (c-input? c)))                            ;; yes, dependent cells can be inputp\n\n    ;;(println :optimizing-away!!!! (c-slot c)(c-useds c))\n    (rmap-setf [::cty/state c] :optimized-away)             ;; leaving this for now, but we toss\n                                        ; the cell below. hhack\n    (c-observe c prior-value :opti-away)\n\n    (when-let [me (c-model c)]\n      ;; (when (= :login (:name @me))   (println :opti-away-nails-cz!!!!!!!!!! (c-slot c)))\n      (rmap-meta-setf [:cz me] (assoc (:cz (meta me)) (c-slot c) nil))\n      (md-cell-flush c))\n    \n    ;; let callers know they need not check us for currency again\n    (doseq [caller (seq (c-callers c))]\n      (#?(:clj alter :cljs swap!) caller assoc :useds (remove #{c} (c-useds caller)))\n      (caller-drop c caller)\n      ;;; (trc \"nested opti\" c caller)\n      ;;(optimize-away?! caller) ;; rare but it happens when rule says (or .cache ...)\n      (ensure-value-is-current caller :opti-used c))        ;; this will get round to optimizing\n                                        ; them if necessary, and if not they do need\n                                        ; to have one last notification if this was\n                                        ; a rare mid-life optimization\n    (#?(:clj ref-set :cljs reset!) c (c-value c))\n    ))\n\n;; --- c-quiesce -----------\n\n(defn c-quiesce [c]\n  (assert c)\n  (unlink-from-callers c)\n  (unlink-from-used c :quiesce)\n  (#?(:clj ref-set :cljs reset!) c :dead-c))\n\n;; --- not-to-be --\n\n(defn not-to-be-self [me]\n  (doseq [c (vals (:cz (meta me)))]\n    (when c                                                 ;; not if optimized away\n      (c-quiesce c)))\n  (#?(:clj ref-set :cljs reset!) me nil)\n  (rmap-meta-setf [::cty/state me] :dead))\n\n(defmulti not-to-be (fn [me]\n                      (assert (md-ref? me))\n                      [(ia-type me)]))\n\n(defmethod not-to-be :default [me]\n  (println :not2be-default (type (when me @me)) (:id @me) me)\n  (not-to-be-self me))\n\n;----------------- change detection ---------------------------------\n\n(defmulti unchanged-test\n  \"Cells does not propagate when nothing changes. By default, the\n  test is =, but cells can inject a different test, and when we get\n  to models it will be possible for a slot to have associated\n  with it a different test.\"\n\n  (fn [me slot]\n    [(when me (type @me)) slot]))\n\n(defmethod unchanged-test :default [self slotname]\n  =)\n\n(defn c-value-changed? [c new-value old-value]\n  (not ((or (:unchanged-if @c)\n            (unchanged-test (c-model c) (c-slot c)))\n        new-value old-value)))\n\n;;--------------- change propagation  ----------------------------\n\n(def ^:dynamic *custom-propagater* nil)\n\n(declare propagate-to-callers\n\n         md-slot-cell-flushed)\n\n(defn propagate\n  \"A cell:\n  - notifies its callers of its change;\n  - calls any observer; and\n  - if ephemeral, silently reverts to nil.\"\n\n  ;; /do/ support other values besides nil as the \"resting\" value \n\n  [c prior-value callers]\n\n  ;; (trx :propagate (:slot @c))\n\n  (cond\n    *one-pulse?* (when *custom-propagater*\n                   (*custom-propagater* c prior-value))\n    ;; ----------------------------------\n    :else\n    (do\n      ;;(println :upd-pulse-last-chg-to @+pulse+ c)\n      (rmap-setf [:pulse-last-changed c] @+pulse+)\n\n      (binding [*depender* nil\n                *call-stack* nil\n                *c-prop-depth*  (inc *c-prop-depth*)\n                *defer-changes* true]\n        ;; --- manifest new value as needed ---\n        ;;\n        ;; 20061030 Trying not.to.be first because doomed instances may be interested in callers\n        ;; who will decide to propagate. If a family instance kids slot is changing, a doomed kid\n        ;; will be out of the kids but not yet quiesced. If the propagation to this rule asks the kid\n        ;; to look at its siblings (say a view instance being deleted from a stack who looks to the psib\n        ;; pb to decide its own pt), the doomed kid will still have a parent but not be in its kids slot\n        ;; when it goes looking for a sibling relative to its position.\n        (when (and prior-value\n                   (c-model c)\n                   (md-slot-owning? (type (c-model c)) (c-slot c)))\n          (when-let [ownees (difference (set-ify prior-value) (set-ify (c-value c)))]\n            (doseq [ownee ownees]\n              (not-to-be ownee))))\n\n        (propagate-to-callers c callers)\n        ;;(trx :obs-chkpulse!!!!!!!! @+pulse+ (c-pulse-observed c))\n\n        (when-not (c-optimized-away? c)                     ;; they get observed at the time\n          ;;(trx :not-opti!!!! @c)\n          (when (or (> @+pulse+ (c-pulse-observed c))\n                  (some #{(c-lazy c)}\n                    [:once-asked :always true]))            ;; messy: these can get setfed/propagated twice in one pulse+\n            ;;(println :observing!!!!!!!!!!! (c-slot c) (c-value c))\n            (c-observe c prior-value :propagate)))\n\n        ;;\n        ;; with propagation done, ephemerals can be reset. we also do this in c-awaken, so\n        ;; let the fn decide if C really is ephemeral. Note that it might be possible to leave\n        ;; this out and use the pulse to identify obsolete ephemerals and clear them\n        ;; when read. That would avoid ever making again bug I had in which I had the reset\n        ;; inside slot-value-observe,\n        ;; thinking that that always followed propagation to callers. It would also make\n        ;; debugging easier in that I could find the last ephemeral value in the inspector.\n        ;; would this be bad for persistent CLOS, in which a DB would think there was still a link\n        ;; between two records until the value actually got cleared?\n        ;;\n        (ephemeral-reset c)))))\n\n(defn propagate-to-callers [c callers]\n  ;;\n  ;;  We must defer propagation to callers because of an edge case in which:\n  ;;    - X tells A to recalculate\n  ;;    - A asks B for its current value\n  ;;    - B must recalculate because it too uses X\n  ;;    - if B propagates to its callers after recalculating instead of deferring it\n  ;;       - B might tell H to reclaculate, where H decides this time to use A\n  ;;       - but A is in the midst of recalculating, and cannot complete until B returns.\n  ;;         but B is busy eagerly propagating. \"This time\" is important because it means\n  ;;         there is no way one can reliably be sure H will not ask for A\n  ;;\n  (when-not (empty? callers)\n    (let [causation (cons c *causation*)]                   ;; closed over below\n      (with-integrity (:tell-dependents c)\n        (if (mdead? (c-model c))\n          (do (trx \"WHOAA!!!! dead by time :tell-deps dispatched; bailing\" c))\n          (binding [*causation* causation]\n            (doseq [caller (seq callers)]\n              (cond\n               (or                                          ;; lotsa reasons NOT to proceed\n                (= (c-state caller) :quiesced)\n                (c-current? caller)                         ;; happens if I changed when caller used me in current pulse+\n                (some #{(c-lazy caller)} [true :always :once-asked])\n\n                (and (not (some #{c} (c-useds caller)))     ; hard to follow, but it is trying to say\n                     (not (c-optimized-away? c)))   )       ; \"go ahead and notify caller one more time\n                                        ; even if I have been optimized away cuz they need to know.\"\n                                        ; Note this is why callers must be supplied, having been copied\n                                        ; before the optimization step.\n               (do #_ (trx :not-propping @+pulse+ (c-slot c)\n                     ;; :val (c-value c)\n                     :to (c-slot caller) :caller            ;; @caller\n                     (c-state caller) :current (c-current? caller)\n                     :c-not-used? (not (some #{c} (c-useds caller)))\n                     :c-not-opti (not (c-optimized-away? c))))\n\n               :else\n               (calculate-and-set caller :propagate c)))))))))\n"]}